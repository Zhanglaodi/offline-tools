<!doctype html>
<html lang="zh-CN">
<head>
    <!-- 必须的 meta 标签 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 的 CSS 文件 -->
    <link href="./lib/bootstrap/bootstrap.min.css" rel="stylesheet">

    <title>离线版-车辆工具</title>
</head>
<body>

<div class="grid" style="margin:10px">
    <div class="g-col-12" style="text-align: center">
        <input type="file" id="upload_file" onchange="get_file_context(this)" accept=".asc" style="display: none">
        <button type="button" class="btn btn-primary" onclick="$('#upload_file').click()"><img
                src="./static/icon/upload.png" style="height: 30px">
            <span id="btn-upload-file-name">上传文件</span>
        </button>
    </div>
</div>
<hr>
<div style="margin: 1%">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#base-test">基础测试</a>
        </li>
        <!--        <li class="nav-item">-->
        <!--            <a class="nav-link" data-bs-toggle="tab" href="#performance-test">性能测试</a>-->
        <!--        </li>-->
        <!--        <li class="nav-item">-->
        <!--            <a class="nav-link" data-bs-toggle="tab" href="#zdy">自定义</a>-->
        <!--        </li>-->
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
        <div id="base-test" class="tab-pane active"><br>
            <iframe src="./view/index/index.html" width="100%" height="800px" id="index"></iframe>
        </div>
        <!--        <div id="performance-test" class="tab-pane"><br>-->
        <!--            <iframe src="./view/index/performance_test.html" width="100%" height="800px" id="performance_test"></iframe>-->
        <!--        </div>-->
        <!--        <div id="zdy" class="tab-pane active"><br>-->
        <!--            <h3>其他页面</h3>-->
        <!--        </div>-->
    </div>
</div>


<!-- 引入 JQuery -->
<script src="./lib/jquery/jquery.min.js"></script>
<!-- 引入 Layer -->
<script src="./lib/layer/layer.js"></script>
<!-- 包含 Popper 的 Bootstrap 集成包 -->
<script src="./lib/bootstrap/bootstrap.bundle.min.js"></script>
<script>
    // 通用文件内容
    let file_context = {};
    // CAN ID
    let can_id = [];

    // 7.0.0 版本 —— 以第一条记录为零点，保留 6 位小数
    function version_7_0_0(_file_context) {
        _file_context = _file_context.slice(3);
        _file_context[Symbol.iterator] = function iterator() {
            let self = this, keys = Reflect.ownKeys(self), index = 0
            return {
                next() {
                    if (index > keys.length - 1) return {done: true, value: undefined};
                    return {done: false, value: self[keys[index++]]};
                }
            }
        }
        file_context = [];
        can_id = [];

        let first_time = null; // 记录首个绝对时间

        for (let row of _file_context) {
            if (row.length > 5 && (row = row.split(' '))) {
                if (row.length > 5) {
                    if (first_time === null) {
                        first_time = parseFloat(row[0]);
                    }
                    const t_rel = (parseFloat(row[0]) - first_time).toFixed(6);

                    can_id.push(row[2]);
                    file_context[row[2]] = file_context[row[2]] || [];
                    file_context[row[2]].push({
                        'can_id': row[2],
                        'time': t_rel,
                        'data': row.splice(6, 8)
                    });
                }
            }
        }
        return [can_id, file_context];
    }

    // 版本找不到 —— 已有归零逻辑，这里统一保留 6 位小数
    function version_not_found(_file_context) {
        _file_context = _file_context.slice(2);
        _file_context[Symbol.iterator] = function iterator() {
            let self = this, keys = Reflect.ownKeys(self), index = 0
            return {
                next() {
                    if (index > keys.length - 1) return {done: true, value: undefined};
                    return {done: false, value: self[keys[index++]]};
                }
            }
        }

        file_context = [];
        can_id = [];
        let can_id_list, _can_id, first_time = -1;
        for (let row of _file_context) {
            if (row.length > 5 && (row = row.split(' '))) {
                row[0] = row[0].replace('\t1', '');
                if (first_time === -1) {
                    first_time = parseFloat(row[0]);
                }
                row[0] = (parseFloat(row[0]) - first_time).toFixed(6);

                can_id_list = row[1].split('\t');
                _can_id = can_id_list[0];
                if (row.length > 5 && can_id.push(_can_id)) {
                    file_context[_can_id] = file_context[_can_id] || [];
                    file_context[_can_id].push({
                        'can_id': _can_id,
                        'time': row[0],
                        'data': [can_id_list[can_id_list.length - 1], ...row.splice(2, 7)]
                    });
                }
            }
        }
        return [can_id, file_context];
    }
	// === 原来就有的，别删 ===
    function get_file_context(obj) {
        let file = obj.files[0];
        let file_type = file.name.split('.');
        if (file_type[file_type.length - 1] !== 'asc') {
            return layer.msg('非法文件类型');
        }
        $('#btn-upload-file-name').html(file.name + ' 上传中...')

        let reader = new FileReader();
        reader.readAsText(file, 'gbk');
        reader.onload = () => {
            let fileData = reader.result;
            let _file_context = fileData.split('\n');

            if (_file_context[2].endsWith('7.0.0\r')) {
                [can_id, file_context] = version_7_0_0(_file_context);
            } else {
                [can_id, file_context] = version_not_found(_file_context);
            }

            can_id = new Set(can_id);
            document.getElementById('index').contentWindow
                .postMessage({file_context, can_id: [...can_id]}, '*');
            $('#btn-upload-file-name').html(file.name + ' 上传完成');
        };
        $('#upload_file').val('');
    }
</script>
</body>
</html>