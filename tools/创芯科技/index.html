<!doctype html>
<html lang="zh-CN">
<head>
    <!-- 必须的 meta 标签 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 的 CSS 文件 -->
    <link href="./lib/bootstrap/bootstrap.min.css" rel="stylesheet">

    <title>离线版-车辆工具</title>
</head>
<body>

<div class="grid" style="margin:10px">
    <div class="g-col-12" style="text-align: center">
        <input type="file" id="upload_file" onchange="get_file_context(this)" accept=".csv" style="display: none">
        <button type="button" class="btn btn-primary" onclick="$('#upload_file').click()"><img
                src="./static/icon/upload.png" style="height: 30px">
            <span id="btn-upload-file-name">上传文件</span>
        </button>
    </div>
</div>
<hr>
<div style="margin: 1%">
    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#base-test">基础测试</a>
        </li>
<!--        <li class="nav-item">-->
<!--            <a class="nav-link" data-bs-toggle="tab" href="#performance-test">性能测试</a>-->
<!--        </li>-->
        <!--        <li class="nav-item">-->
        <!--            <a class="nav-link" data-bs-toggle="tab" href="#zdy">自定义</a>-->
        <!--        </li>-->
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
        <div id="base-test" class="tab-pane active"><br>
            <iframe src="./view/index/index.html" width="100%" height="800px" id="index"></iframe>
        </div>
<!--        <div id="performance-test" class="tab-pane"><br>-->
<!--            <iframe src="./view/index/performance_test.html" width="100%" height="800px" id="performance_test"></iframe>-->
<!--        </div>-->
        <!--        <div id="zdy" class="tab-pane active"><br>-->
        <!--            <h3>其他页面</h3>-->
        <!--        </div>-->
    </div>
</div>


<!-- 引入 JQuery -->
<script src="./lib/jquery/jquery.min.js"></script>
<!-- 引入 Layer -->
<script src="./lib/layer/layer.js"></script>
<!-- 包含 Popper 的 Bootstrap 集成包 -->
<script src="./lib/bootstrap/bootstrap.bundle.min.js"></script>
<script>
    // 通用文件内容
    let file_context = {};
    // CAN ID
    let can_id = [];
	
    let time_context = [];
    function get_file_context(obj) {
        // 读取文件
        let file = obj.files[0];
        // 判断文件类型
        let file_type = file.name.split('.');	//取到文件名并使用“.”进行切割
        if (file_type[file_type.length - 1] !== 'csv') {	//判断文件类型
            return layer.msg('非法文件类型');
        }
        $('#btn-upload-file-name').html(file.name + ' 上传中...')
        // 获取内容
        let reader = new FileReader();
        reader.readAsText(file, 'gbk');
        reader.onload = () => {
            let fileData = reader.result;	//获取读取的数据
            let _file_context = fileData.split('\r\n');
            // 使用 迭代器 防止内存泄漏
            _file_context[Symbol.iterator] = function iterator() {
                let self = this, keys = Reflect.ownKeys(self), index = 0
                return {
                    next() {
                        if (index > keys.length - 1) {
                            return {
                                done: true,
                                value: undefined
                            };
                        }
                        return {
                            done: false,
                            value: self[keys[index++]]
                        };
                    }
                }
            }
            file_context = [];
			time_context = [];
            can_id = [];
            let start_time, _time, _can_id, _h_time;
            for (let row of _file_context) {
                if (row.length > 5 && (row = row.split(',')) && (row[5].indexOf('0x') >= 0)) {
                    _time = row[1].substring(2, 14).split('.')
					_h_time=row[1].substring(0, 14);
                    _time = (new Date('1970-01-01 ' + _time[0]).valueOf() / 1000) + '.' + _time[1];
                    start_time = start_time || _time
                    _can_id = row[5].substring(2)
                    if (can_id.push(_can_id)) {
                        file_context[_can_id] = file_context[_can_id] || []
                        file_context[_can_id].push({
                            'can_id': _can_id,
                            'time': (_time - start_time).toFixed(3),
                            'data': row[9].split(' ').splice(1, 8)
                        });
						time_context[_can_id] = time_context[_can_id] || [];
						time_context[_can_id].push({
							'can_id': _can_id,
							 'timestamp': (_time - start_time).toFixed(3),
							 'time': _h_time
						});
                    }
                }
            }
            can_id = new Set(can_id);
            document.getElementById('index').contentWindow.postMessage({file_context, can_id: [...can_id]}, '*');
            // document.getElementById('performance_test').contentWindow.postMessage({
            //     file_context,
            //     can_id: [...can_id]
            // }, '*');
			console.log(time_context);
            $('#btn-upload-file-name').html(file.name + ' 上传完成')
        };
        // 清空已选文件
        $('#upload_file').val('')
    }
</script>
</body>
</html>