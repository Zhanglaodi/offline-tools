<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DBC Mini — Browser Edition</title>
<style>
  :root{
    --bg:#0b1220; --panel:#121a2b; --muted:#94a3b8; --text:#e2e8f0; --brand:#60a5fa;
    --line:#1f2937; --accent:#22d3ee; --warn:#fca5a5;
  }
  html,body{height:100%;}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0a1020 40%,#0a0f1d);
       color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;
       letter-spacing:.2px}
  .app{display:grid;grid-template-columns:300px 1fr;gap:0;height:100vh}
  .sidebar{background:var(--panel);border-right:1px solid var(--line);display:flex;flex-direction:column}
  .side-head{padding:16px;border-bottom:1px solid var(--line)}
  .side-head h1{font-size:16px;margin:0 0 8px 0;font-weight:700}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--line);background:#0e1626;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:#334155}
  .btn.primary{background:linear-gradient(180deg,#1d4ed8,#1e40af);border-color:#193995}
  .btn.ghost{background:transparent}
  .btn.small{padding:4px 8px;border-radius:8px;font-size:12px}
  .stack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .side-list{flex:1;overflow:auto}
  .msg-item{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;cursor:pointer}
  .msg-item:hover{background:#0e1628}
  .msg-item.active{background:#13203a}
  .msg-title{font-weight:600}
  .msg-meta{font-size:12px;color:var(--muted)}
  .main{padding:16px 20px;overflow:auto}
  .section{background:rgba(255,255,255,0.02);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
  .section h2{margin:0 0 12px 0;font-size:15px}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type=text], input[type=number], select, textarea{background:#0c1322;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px}
  textarea{min-height:72px;resize:vertical}
  input[type=checkbox]{transform:scale(1.1)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left}
  .table th{font-size:12px;color:var(--muted);font-weight:600}
  .row-actions{display:flex;gap:6px}
  .toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px;color:#cbd5e1;background:#0b1323;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
  .footer{color:var(--muted);font-size:12px}
  dialog{border:none;border-radius:14px;padding:0;background:#0c1322;color:var(--text);box-shadow:0 10px 40px rgba(0,0,0,.5)}
  .modal{min-width:560px;border:1px solid var(--line)}
  .modal-head{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .modal-body{padding:14px 16px}
  .modal-foot{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
  .help{font-size:12px;color:var(--muted)}
  .tag{font-size:11px;border:1px solid var(--line);border-radius:6px;padding:2px 6px}
  .warn{color:#fecaca}
  .right{display:flex;gap:8px;align-items:center}
  .wide{grid-column: span 3}
  @media (max-width:1100px){.app{grid-template-columns:1fr}.sidebar{display:none}}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="side-head">
      <h1>DBC Mini</h1>
      <div class="stack">
        <button class="btn small" id="btnNewMsg">新建消息</button>
        <button class="btn small ghost" id="btnAddNode">添加节点</button>
      </div>
    </div>
    <div class="side-list" id="msgList"></div>
    <div class="side-head">
      <div class="stack" style="justify-content:space-between;gap:6px">
        <span class="pill">节点：<span id="nodeCount">2</span></span>
        <label class="muted" for="selEncoding" style="font-size:12px">编码</label>
        <select id="selEncoding">
          <option value="utf8-bom" selected>UTF‑8 (BOM)</option>
          <option value="utf8">UTF‑8 (无 BOM)</option>
        </select>
        <button class="btn small" id="btnTables">值表</button>
        <button class="btn small primary" id="btnExport">导出 DBC</button>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="section" id="projectInfo">
      <div class="toolbar">
        <h2>项目信息</h2>
        <div class="right"><span class="kbd">Ctrl+S</span><span class="help">导出</span></div>
      </div>
      <div class="grid">
        <div class="field wide"><label>版本</label><input id="inpVersion" type="text" value="1.0"></div>
        <div class="field wide"><label>节点列表（只读）</label><input id="inpNodes" type="text" placeholder="ECU Vector__XXX" readonly></div>
      </div>
    </div>

    <div class="section" id="msgEditor" hidden>
      <div class="toolbar">
        <h2>消息</h2>
        <div class="stack">
          <button class="btn small" id="btnSaveMsg">保存消息</button>
          <button class="btn small ghost" id="btnDelMsg">删除消息</button>
        </div>
      </div>
      <div class="grid">
        <div class="field"><label>CAN ID（支持十进制/0x）</label><input id="msgId" type="text" placeholder="0x123"/></div>
        <div class="field"><label>名称</label><input id="msgName" type="text"/></div>
        <div class="field"><label>DLC</label><input id="msgDlc" type="number" min="0" max="8"/></div>
        <div class="field"><label>发送节点</label><input id="msgTx" type="text"/></div>
        <div class="field"><label>扩展帧</label><div class="stack"><input id="msgExt" type="checkbox"/> <span class="help">标注用途</span></div></div>
        <div class="field wide"><label>备注（Message Comment / CM_ BO_）</label><textarea id="msgCmt" placeholder="此消息的用途/周期/触发条件等"></textarea></div>
      </div>
    </div>

    <div class="section" id="sigSection" hidden>
      <div class="toolbar">
        <h2>信号</h2>
        <div class="stack">
          <button class="btn small" id="btnAddSig">新增信号</button>
        </div>
      </div>
      <table class="table" id="sigTable">
        <thead>
          <tr>
            <th>#</th><th>名称</th><th>start</th><th>len</th><th>端序</th><th>符号</th>
            <th>factor</th><th>offset</th><th>min</th><th>max</th><th>unit</th><th>值表</th><th>接收节点</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="help">端序：@1=Intel(LE) @0=Motorola(BE)；符号：+无符号 -有符号。备注与值表会在导出时写为 <span class="tag">CM_</span> 与 <span class="tag">VAL_</span> / <span class="tag">VAL_TABLE_</span>。默认换行符 CRLF 与 UTF‑8 BOM，兼容 Windows 工具。</div>
    </div>

    <div class="footer">Made for quick DBC drafting. 无依赖，纯前端单文件。</div>
  </main>
</div>

<!-- Signal Modal -->
<dialog id="dlgSignal" class="modal">
  <form method="dialog">
    <div class="modal-head">
      <strong id="dlgTitle">新增信号</strong>
      <button class="btn small ghost" value="cancel" type="submit">×</button>
    </div>
    <div class="modal-body">
      <div class="grid">
        <div class="field"><label>名称</label><input id="sigName" type="text" required></div>
        <div class="field"><label>start_bit (0-63)</label><input id="sigStart" type="number" min="0" max="63" required></div>
        <div class="field"><label>length (1-64)</label><input id="sigLen" type="number" min="1" max="64" required></div>
        <div class="field"><label>端序</label>
          <select id="sigEndian"><option value="1">@1 Intel(LE)</option><option value="0">@0 Motorola(BE)</option></select>
        </div>
        <div class="field"><label>符号</label>
          <select id="sigSigned"><option value="+">无符号(+)</option><option value="-">有符号(-)</option></select>
        </div>
        <div class="field"><label>单位</label><input id="sigUnit" type="text" placeholder="km/h"></div>
        <div class="field"><label>factor</label><input id="sigFactor" type="number" step="any" value="1"></div>
        <div class="field"><label>offset</label><input id="sigOffset" type="number" step="any" value="0"></div>
        <div class="field"><label>min</label><input id="sigMin" type="number" step="any" value="0"></div>
        <div class="field"><label>max</label><input id="sigMax" type="number" step="any" value="0"></div>
        <div class="field" style="grid-column: span 3"><label>接收节点（逗号分隔）</label><input id="sigRecvs" type="text" placeholder="Vector__XXX"></div>
        <div class="field wide"><label>备注（Signal Comment / CM_ SG_）</label><textarea id="sigCmt" placeholder="此信号的含义、边界、诊断说明等"></textarea></div>
        <div class="field wide"><label>值表（选择后导出为 VAL_ 行）</label>
          <div class="stack"><select id="sigValTable"><option value="">(无)</option></select>
          <button type="button" class="btn small" id="btnPreviewTable">查看</button></div>
        </div>
      </div>
      <div class="help">可点击“自动推算范围”按当前 <span class="tag">length</span>/<span class="tag">符号</span>/<span class="tag">factor</span>/<span class="tag">offset</span> 计算 min/max。</div>
    </div>
    <div class="modal-foot">
      <button type="button" class="btn small" id="btnAutoRange">自动推算范围</button>
      <div style="flex:1"></div>
      <button class="btn small ghost" value="cancel" type="submit">取消</button>
      <button class="btn small primary" id="btnSigOk" value="default" type="submit">确定</button>
    </div>
  </form>
</dialog>

<!-- Value Table Manager -->
<dialog id="dlgTables" class="modal">
  <form method="dialog">
    <div class="modal-head">
      <strong>值表管理（VAL_TABLE_ / VAL_）</strong>
      <button class="btn small ghost" value="cancel" type="submit">×</button>
    </div>
    <div class="modal-body">
      <div class="stack" style="justify-content:space-between;margin-bottom:8px">
        <div class="stack"><button type="button" class="btn small" id="btnNewTable">新建值表</button></div>
        <div class="help">提示：导出时会在文件头写出所有 <span class="tag">VAL_TABLE_</span>；被信号选用的表将生成对应 <span class="tag">VAL_</span> 行。</div>
      </div>
      <div id="tableList"></div>
    </div>
    <div class="modal-foot">
      <button class="btn small primary" value="default" type="submit">完成</button>
    </div>
  </form>
</dialog>

<script>
// ---------------- State ----------------
const state = {
  version: '1.0',
  nodes: ['ECU','Vector__XXX'],
  messages: [],
  tables: [], // {name, entries:[{v:number,l:string}]}
  selected: null, // index of selected message
};

// ---------------- Helpers ----------------
function parseId(s){ s = (s||'').trim(); if(!s) return 0; return s.startsWith('0x')||s.startsWith('0X') ? parseInt(s,16) : parseInt(s,10); }
function fmtHex(id){ return '0x' + (id>>>0).toString(16); }
function computePhysRange(len, signed, factor, offset){
  if(len<=0||len>64) throw new Error('length 必须在 1..64');
  let rawMin, rawMax;
  if(signed){ rawMin = - (1n << BigInt(len-1)); rawMax = (1n << BigInt(len-1)) - 1n; }
  else { rawMin = 0n; rawMax = (1n << BigInt(len)) - 1n; }
  const f = Number(factor), o = Number(offset);
  const min = Number(rawMin) * f + o; const max = Number(rawMax) * f + o;
  return [Number(min.toFixed(6)), Number(max.toFixed(6))];
}
function ensureNode(name){ if(!name) return; if(!state.nodes.includes(name)) state.nodes.push(name); }
function getTableByName(n){ return state.tables.find(t=>t.name===n); }

// ---------------- Render ----------------
const els = {
  list: document.getElementById('msgList'),
  nodeCount: document.getElementById('nodeCount'),
  inpVersion: document.getElementById('inpVersion'),
  inpNodes: document.getElementById('inpNodes'),
  msgEditor: document.getElementById('msgEditor'),
  sigSection: document.getElementById('sigSection'),
  msgId: document.getElementById('msgId'),
  msgName: document.getElementById('msgName'),
  msgDlc: document.getElementById('msgDlc'),
  msgTx: document.getElementById('msgTx'),
  msgExt: document.getElementById('msgExt'),
  msgCmt: document.getElementById('msgCmt'),
  sigTableBody: document.querySelector('#sigTable tbody'),
  btnTables: document.getElementById('btnTables'),
  selEnc: document.getElementById('selEncoding'),
};

function renderSidebar(){
  els.list.innerHTML = '';
  state.messages.forEach((m, i)=>{
    const div = document.createElement('div');
    div.className = 'msg-item' + (i===state.selected?' active':'');
    const cmtIcon = m.comment? ' 📝' : '';
    div.innerHTML = `<div style="flex:1">
      <div class="msg-title">${m.name||'(未命名)'} ${cmtIcon} <span class="tag">${fmtHex(m.can_id)}</span></div>
      <div class="msg-meta">DLC ${m.dlc} · TX ${m.transmitter} · SIGS ${m.signals.length}</div>
    </div>`;
    div.onclick = ()=>{ state.selected = i; render(); };
    els.list.appendChild(div);
  });
  document.getElementById('nodeCount').textContent = state.nodes.length;
  els.inpNodes.value = state.nodes.join(' ');
}

function fillValTableSelect(selectEl){
  const cur = selectEl.value;
  selectEl.innerHTML = '<option value="">(无)</option>' + state.tables.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
  if(cur) selectEl.value = cur;
}

function renderMsgPanel(){
  const has = state.selected!=null && state.messages[state.selected];
  els.msgEditor.hidden = !has; els.sigSection.hidden = !has;
  if(!has) return;
  const m = state.messages[state.selected];
  els.msgId.value = m.can_id ? (m.can_id>=0x10 ? '0x'+m.can_id.toString(16) : String(m.can_id)) : '0x0';
  els.msgName.value = m.name||'';
  els.msgDlc.value = m.dlc;
  els.msgTx.value = m.transmitter||'ECU';
  els.msgExt.checked = !!m.is_extended;
  els.msgCmt.value = m.comment||'';
  renderSignals(m);
}

function renderSignals(m){
  els.sigTableBody.innerHTML = '';
  m.signals.forEach((s, idx)=>{
    const tr = document.createElement('tr');
    const endian = s.intel_little_endian? '@1':'@0';
    const sign = s.signed? '-' : '+';
    const rec = (s.receivers && s.receivers.length) ? s.receivers.join(',') : 'Vector__XXX';
    tr.innerHTML = `
      <td>${idx}</td>
      <td>${s.name}${s.comment? ' 📝':''}</td>
      <td>${s.start_bit}</td>
      <td>${s.length}</td>
      <td>${endian}</td>
      <td>${sign}</td>
      <td>${s.factor}</td>
      <td>${s.offset}</td>
      <td>${s.minimum}</td>
      <td>${s.maximum}</td>
      <td>${s.unit||''}</td>
      <td>${s.val_table||''}</td>
      <td>${rec}</td>
      <td class="row-actions">
        <button class="btn small" data-act="edit" data-idx="${idx}">编辑</button>
        <button class="btn small ghost" data-act="up" data-idx="${idx}">↑</button>
        <button class="btn small ghost" data-act="down" data-idx="${idx}">↓</button>
        <button class="btn small" data-act="del" data-idx="${idx}">删除</button>
      </td>`;
    els.sigTableBody.appendChild(tr);
  });
}

function render(){
  state.version = els.inpVersion.value;
  renderSidebar();
  renderMsgPanel();
}

// ---------------- DBC Export ----------------
function escQuote(s){ return (s||'').replace(/"/g,'\\"'); }
function messageToDBC(m){
  const head = `BO_ ${m.can_id} ${m.name}: ${m.dlc} ${m.transmitter}`;
  const sigs = m.signals.map(s=>{
    const endian = s.intel_little_endian? '1':'0';
    const sign = s.signed? '-' : '+';
    const recv = (s.receivers && s.receivers.length ? s.receivers.join(',') : 'Vector__XXX');
    const mux = s.is_multiplexer? ` m${s.multiplexer_switch_value}`: '';
    return ` SG_ ${s.name}${mux} : ${s.start_bit}|${s.length}@${endian}${sign} (${s.factor},${s.offset}) [${s.minimum}|${s.maximum}] "${s.unit||''}" ${recv}`;
  });
  return head + (sigs.length? '\n' + sigs.join('\n') : '');
}

const DEFAULT_NS = [
  "NS_DESC_","CM_","BA_DEF_","BA_","VAL_","CAT_DEF_","CAT_","FILTER","BA_DEF_DEF_","EV_DATA_","ENVVAR_DATA_","SGTYPE_","SGTYPE_VAL_","BA_DEF_SGTYPE_","BA_SGTYPE_","SIG_TYPE_REF_","VAL_TABLE_","SIG_GROUP_","SIG_VALTYPE_","SIGTYPE_VALTYPE_","BO_TX_BU_","BA_DEF_REL_","BA_REL_","BA_DEF_DEF_REL_","BU_SG_REL_","BU_EV_REL_","BU_BO_REL_","SG_MUL_VAL_"
];

function buildDBC(){
  const NL = '\r\n';
  const lines = [];
  // Header
  lines.push(`VERSION "${escQuote(state.version)}"`);
  lines.push('');
  lines.push('NS_:');
  DEFAULT_NS.forEach(ns=>lines.push('  '+ns));
  lines.push('');
  lines.push('BS_:');
  lines.push('');
  lines.push('BU_: ' + state.nodes.join(' '));
  lines.push('');

  // Value table definitions (VAL_TABLE_)
  state.tables.forEach(t=>{
    if(!t.entries || !t.entries.length) return;
    const pairs = t.entries.map(e=>`${e.v} "${escQuote(e.l)}"`).join(' ');
    lines.push(`VAL_TABLE_ ${t.name} ${pairs} ;`);
  });
  if(state.tables.length) lines.push('');

  // Messages + Signals
  state.messages.forEach(m=>{ lines.push(messageToDBC(m)); lines.push(''); });

  // Comments
  state.messages.forEach(m=>{
    if(m.comment && m.comment.trim()) lines.push(`CM_ BO_ ${m.can_id} "${escQuote(m.comment.trim())}";`);
    m.signals.forEach(s=>{
      if(s.comment && s.comment.trim()) lines.push(`CM_ SG_ ${m.can_id} ${s.name} "${escQuote(s.comment.trim())}";`);
    });
  });

  // VAL_ for signals referencing a value table
  state.messages.forEach(m=>{
    m.signals.forEach(s=>{
      if(s.val_table){
        const t = getTableByName(s.val_table);
        if(t && t.entries && t.entries.length){
          const pairs = t.entries.map(e=>`${e.v} "${escQuote(e.l)}"`).join(' ');
          lines.push(`VAL_ ${m.can_id} ${s.name} ${pairs} ;`);
        }
      }
    });
  });

  const textLF = lines.join('\n');
  return textLF.replace(/\r?\n/g, NL); // enforce CRLF
}

function generateExportText(encoding){
  let text = buildDBC();
  // prepend BOM if requested
  if(encoding === 'utf8-bom') text = '\uFEFF' + text;
  return text;
}

function saveDBC(){
  const enc = els.selEnc.value || 'utf8-bom';
  const text = generateExportText(enc);
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'project.dbc';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ---------------- Events ----------------

document.getElementById('btnExport').onclick = saveDBC;

document.getElementById('btnNewMsg').onclick = ()=>{
  const m = { can_id:0x100, name:'NewMessage', dlc:8, transmitter:'ECU', is_extended:false, signals:[], comment:'' };
  state.messages.push(m);
  ensureNode(m.transmitter);
  state.selected = state.messages.length-1;
  render();
};

document.getElementById('btnAddNode').onclick = ()=>{
  const name = prompt('输入节点名称');
  if(name){ ensureNode(name.trim()); render(); }
};

document.getElementById('btnSaveMsg').onclick = ()=>{
  const m = state.messages[state.selected];
  m.can_id = parseId(els.msgId.value)||0;
  m.name = els.msgName.value.trim()||'Unnamed';
  m.dlc = Math.max(0, Math.min(8, parseInt(els.msgDlc.value||'8',10)));
  m.transmitter = els.msgTx.value.trim()||'ECU'; ensureNode(m.transmitter);
  m.is_extended = !!els.msgExt.checked;
  m.comment = els.msgCmt.value||'';
  render();
};

document.getElementById('btnDelMsg').onclick = ()=>{
  if(state.selected==null) return;
  const m = state.messages[state.selected];
  if(confirm(`确认删除消息 ${m.name}?`)){
    state.messages.splice(state.selected,1);
    state.selected = state.messages.length? 0 : null;
    render();
  }
};

document.getElementById('btnAddSig').onclick = ()=> openSignalDialog();

document.querySelector('#sigTable').addEventListener('click', (e)=>{
  const act = e.target.getAttribute('data-act');
  if(!act) return;
  const idx = parseInt(e.target.getAttribute('data-idx'),10);
  const m = state.messages[state.selected];
  if(act==='edit') openSignalDialog(m.signals[idx], idx);
  if(act==='del'){
    if(confirm('确认删除该信号?')){ m.signals.splice(idx,1); render(); }
  }
  if(act==='up' && idx>0){ const s=m.signals.splice(idx,1)[0]; m.signals.splice(idx-1,0,s); render(); }
  if(act==='down' && idx<m.signals.length-1){ const s=m.signals.splice(idx,1)[0]; m.signals.splice(idx+1,0,s); render(); }
});

// Keyboard: Ctrl+S export
window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveDBC(); }});

// ---------------- Signal Dialog ----------------
const dlg = document.getElementById('dlgSignal');
const dlgEls = {
  title: document.getElementById('dlgTitle'),
  name: document.getElementById('sigName'),
  start: document.getElementById('sigStart'),
  len: document.getElementById('sigLen'),
  endian: document.getElementById('sigEndian'),
  signed: document.getElementById('sigSigned'),
  unit: document.getElementById('sigUnit'),
  factor: document.getElementById('sigFactor'),
  offset: document.getElementById('sigOffset'),
  min: document.getElementById('sigMin'),
  max: document.getElementById('sigMax'),
  recvs: document.getElementById('sigRecvs'),
  cmt: document.getElementById('sigCmt'),
  tableSel: document.getElementById('sigValTable'),
  btnPreviewTable: document.getElementById('btnPreviewTable'),
  btnAuto: document.getElementById('btnAutoRange'),
  btnOk: document.getElementById('btnSigOk'),
};
let editingIndex = null;

function openSignalDialog(signal=null, index=null){
  editingIndex = index;
  dlgEls.title.textContent = index==null? '新增信号':'编辑信号';
  const s = signal || {name:'Signal', start_bit:0, length:8, intel_little_endian:true, signed:false, factor:1, offset:0, minimum:0, maximum:0, unit:'', receivers:['Vector__XXX'], is_multiplexer:false, multiplexer_switch_value:0, comment:'', val_table:''};
  dlgEls.name.value = s.name;
  dlgEls.start.value = s.start_bit;
  dlgEls.len.value = s.length;
  dlgEls.endian.value = s.intel_little_endian? '1':'0';
  dlgEls.signed.value = s.signed? '-' : '+';
  dlgEls.unit.value = s.unit || '';
  dlgEls.factor.value = s.factor;
  dlgEls.offset.value = s.offset;
  dlgEls.min.value = s.minimum;
  dlgEls.max.value = s.maximum;
  dlgEls.recvs.value = (s.receivers||['Vector__XXX']).join(',');
  dlgEls.cmt.value = s.comment||'';
  fillValTableSelect(dlgEls.tableSel);
  dlgEls.tableSel.value = s.val_table||'';
  dlg.showModal();
}

dlgEls.btnAuto.addEventListener('click', ()=>{
  try{
    const len = parseInt(dlgEls.len.value,10);
    const signed = dlgEls.signed.value==='-';
    const factor = parseFloat(dlgEls.factor.value||'1');
    const offset = parseFloat(dlgEls.offset.value||'0');
    const [mn, mx] = computePhysRange(len, signed, factor, offset);
    dlgEls.min.value = mn; dlgEls.max.value = mx;
  }catch(err){ alert('自动推算失败：'+err.message); }
});

dlgEls.btnPreviewTable.addEventListener('click', ()=>{
  const t = getTableByName(dlgEls.tableSel.value);
  if(!t){ alert('未选择值表'); return; }
  const lines = t.entries.map(e=>`${e.v} -> ${e.l}`).join('\n') || '(空)';
  alert(`值表 ${t.name}:\n${lines}`);
});

dlg.addEventListener('close', ()=>{
  if(dlg.returnValue==='cancel') return; // user canceled
  const m = state.messages[state.selected];
  const recvs = (dlgEls.recvs.value||'').split(',').map(x=>x.trim()).filter(Boolean);
  if(!recvs.length) recvs.push('Vector__XXX');
  recvs.forEach(ensureNode);
  const s = {
    name: dlgEls.name.value.trim()||'Signal',
    start_bit: parseInt(dlgEls.start.value||'0',10),
    length: parseInt(dlgEls.len.value||'1',10),
    intel_little_endian: dlgEls.endian.value==='1',
    signed: dlgEls.signed.value==='-',
    factor: parseFloat(dlgEls.factor.value||'1'),
    offset: parseFloat(dlgEls.offset.value||'0'),
    minimum: parseFloat(dlgEls.min.value||'0'),
    maximum: parseFloat(dlgEls.max.value||'0'),
    unit: dlgEls.unit.value||'',
    receivers: recvs,
    is_multiplexer: false,
    multiplexer_switch_value: 0,
    comment: dlgEls.cmt.value||'',
    val_table: dlgEls.tableSel.value||'',
  };
  if(editingIndex==null) m.signals.push(s); else m.signals[editingIndex] = s;
  render();
});

// ---------------- Value Table Manager ----------------
const dlgTables = document.getElementById('dlgTables');
const tableList = document.getElementById('tableList');

document.getElementById('btnTables').onclick = ()=>{ renderTableList(); dlgTables.showModal(); };

document.getElementById('btnNewTable').onclick = ()=>{
  const name = prompt('值表名称（仅字母数字下划线）');
  if(!name) return;
  if(state.tables.find(t=>t.name===name)){ alert('已存在同名值表'); return; }
  state.tables.push({name, entries:[]});
  renderTableList();
};

function renderTableList(){
  tableList.innerHTML = '';
  if(!state.tables.length){ tableList.innerHTML = '<div class="help">暂无值表，点击“新建值表”开始。</div>'; return; }
  state.tables.forEach((t, ti)=>{
    const wrap = document.createElement('div');
    wrap.className = 'section';
    wrap.innerHTML = `
      <div class="toolbar">
        <h2 style="margin:0">${t.name}</h2>
        <div class="stack">
          <button class="btn small" data-act="add" data-ti="${ti}">添加条目</button>
          <button class="btn small" data-act="rename" data-ti="${ti}">重命名</button>
          <button class="btn small" data-act="del" data-ti="${ti}">删除</button>
        </div>
      </div>
      <table class="table"><thead><tr><th>值</th><th>标签</th><th>操作</th></tr></thead><tbody id="tb-${ti}"></tbody></table>`;
    tableList.appendChild(wrap);
    const tbody = wrap.querySelector('tbody');
    t.entries.forEach((e, ei)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.v}</td><td>${e.l}</td><td class="row-actions">
        <button class="btn small" data-act="edit-entry" data-ti="${ti}" data-ei="${ei}">编辑</button>
        <button class="btn small" data-act="del-entry" data-ti="${ti}" data-ei="${ei}">删除</button>
      </td>`;
      tbody.appendChild(tr);
    });
  });
}

tableList.addEventListener('click', (e)=>{
  const act = e.target.getAttribute('data-act');
  if(!act) return;
  const ti = parseInt(e.target.getAttribute('data-ti')||'-1',10);
  const ei = parseInt(e.target.getAttribute('data-ei')||'-1',10);
  const t = state.tables[ti];
  if(!t) return;
  if(act==='add'){
    const v = Number(prompt('原始值 (整数)')||''); if(!Number.isFinite(v)) return;
    const l = prompt('标签 (会被双引号包裹)')||'';
    t.entries.push({v, l}); renderTableList();
  }
  if(act==='edit-entry'){
    const cur = t.entries[ei]; if(!cur) return;
    const v = Number(prompt('原始值 (整数)', cur.v)||''); if(!Number.isFinite(v)) return;
    const l = prompt('标签', cur.l)||cur.l;
    t.entries[ei] = {v,l}; renderTableList();
  }
  if(act==='del-entry'){
    if(confirm('删除该条目？')){ t.entries.splice(ei,1); renderTableList(); }
  }
  if(act==='rename'){
    const newName = prompt('新名称', t.name)||t.name;
    if(state.tables.find(x=>x!==t && x.name===newName)){ alert('存在同名值表'); return; }
    t.name = newName; renderTableList();
  }
  if(act==='del'){
    if(confirm('删除整个值表？这不会影响已存在的信号，但它们将不再导出 VAL_。')){
      state.tables.splice(ti,1); renderTableList();
    }
  }
});

// Project header bindings
els.inpVersion.addEventListener('input', ()=>{ state.version = els.inpVersion.value; });

// ---------------- Self-tests ----------------
(function runSelfTests(){
  try {
    const backup = {
      version: state.version,
      nodes: [...state.nodes],
      messages: JSON.parse(JSON.stringify(state.messages)),
      tables: JSON.parse(JSON.stringify(state.tables)),
    };

    state.version = 'TEST中文';
    state.nodes = ['ECU'];
    state.messages = [{ can_id:1, name:'T', dlc:8, transmitter:'ECU', is_extended:false, comment:'备注中文OK', signals:[] }];
    state.tables = [{ name:'TBL', entries:[{v:0,l:'零'},{v:1,l:'一'}] }];

    const m0 = state.messages[0];
    m0.signals.push({name:'A', start_bit:0, length:8, intel_little_endian:true, signed:false, factor:1, offset:0, minimum:0, maximum:255, unit:'单位', receivers:['Vector__XXX'], is_multiplexer:false, multiplexer_switch_value:0, comment:'信号中文', val_table:'TBL'});

    const s1 = messageToDBC(m0);
    console.assert(/\n SG_ A/.test(s1), 'Signal should be on next line');

    const textBom = generateExportText('utf8-bom');
    console.assert(textBom.charCodeAt(0) === 0xFEFF, 'BOM present');
    console.assert(textBom.includes('VERSION "TEST中文"'), 'UTF-8 Chinese preserved');
    console.assert(textBom.includes('VAL_TABLE_ TBL 0 "零" 1 "一" ;'), 'VAL_TABLE_ Chinese');
    console.assert(textBom.includes('CM_ SG_ 1 A "信号中文";'), 'CM_ SG_ Chinese');
    console.assert(/\r\n/.test(textBom), 'CRLF line endings');

    const noBom = generateExportText('utf8');
    console.assert(noBom.charCodeAt(0) !== 0xFEFF, 'No BOM for utf8');

    m0.comment = '含"引号"测试';
    const built = buildDBC();
    console.assert(built.includes('\"'), 'Quotes should be escaped as \\"');

    // restore
    state.version = backup.version;
    state.nodes = backup.nodes;
    state.messages = backup.messages;
    state.tables = backup.tables;
    console.log('Self-tests passed');
  } catch(e) {
    console.warn('Self-tests failed', e);
  }
})();

// Init with one sample (for UI)
state.messages.push({ can_id:0x100, name:'DemoMsg', dlc:8, transmitter:'ECU', is_extended:false, comment:'示例消息：车辆基本状态', signals:[
  {name:'Speed', start_bit:0, length:16, intel_little_endian:true, signed:false, factor:0.1, offset:0, minimum:0, maximum:6553.5, unit:'km/h', receivers:['Vector__XXX'], comment:'车速，分辨率0.1 km/h', val_table:''},
  {name:'Gear', start_bit:16, length:4, intel_little_endian:true, signed:false, factor:1, offset:0, minimum:0, maximum:15, unit:'', receivers:['Vector__XXX'], comment:'档位枚举', val_table:'GearTable'},
]});
state.tables.push({name:'GearTable', entries:[{v:0,l:'N'},{v:1,l:'D'},{v:2,l:'R'},{v:3,l:'P'}]});
renderSidebar(); state.selected = 0; render();
</script>
</body>
</html>
